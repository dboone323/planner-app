default_platform(:ios)

platform :ios do
  private_lane :asc_api_key_config do
    app_store_connect_api_key(
      key_id: ENV["ASC_KEY_ID"],
      issuer_id: ENV["ASC_ISSUER_ID"],
      key_content: ENV["ASC_KEY_CONTENT"],
      is_key_content_base64: true,
      duration: 1200,
      in_house: false
    )
  end

  desc "Run unit and UI tests with coverage"
  lane :test do
    run_tests(
      project: "PlannerApp.xcodeproj",
      scheme: "PlannerApp",
      testplan: "PlannerApp",
      clean: true,
      code_coverage: true
    )
  end

  desc "Build debug for local development"
  lane :build_dev do
    build_app(
      project: "PlannerApp.xcodeproj",
      scheme: "PlannerApp",
      configuration: "Debug",
      clean: true,
      export_method: "development"
    )
  end

  desc "Build release artifact"
  lane :build_release do
    build_app(
      project: "PlannerApp.xcodeproj",
      scheme: "PlannerApp",
      configuration: "Release",
      clean: true,
      export_method: "app-store",
      export_options: {
        provisioningProfiles: {
          ENV.fetch("BUNDLE_IDENTIFIER", "com.DanielStevens.PlannerApp") =>
            ENV.fetch("PROVISIONING_PROFILE_NAME", "")
        }
      }
    )
  end

  desc "Upload latest build to TestFlight"
  lane :beta do
    ensure_git_status_clean
    api_key = asc_api_key_config

    increment_build_number(
      xcodeproj: "PlannerApp.xcodeproj",
      build_number: ENV["BUILD_NUMBER"] || Time.now.strftime("%Y%m%d%H%M")
    )

    build_release

    upload_to_testflight(
      api_key: api_key,
      app_identifier: ENV.fetch("BUNDLE_IDENTIFIER", "com.DanielStevens.PlannerApp"),
      skip_waiting_for_build_processing: true,
      distribute_external: false
    )
  end

  desc "Upload metadata and build to App Store Connect"
  lane :release do
    ensure_git_status_clean
    api_key = asc_api_key_config

    build_release

    deliver(
      api_key: api_key,
      app_identifier: ENV.fetch("BUNDLE_IDENTIFIER", "com.DanielStevens.PlannerApp"),
      skip_metadata: true,
      skip_screenshots: true,
      submit_for_review: false,
      automatic_release: false
    )
  end
end
