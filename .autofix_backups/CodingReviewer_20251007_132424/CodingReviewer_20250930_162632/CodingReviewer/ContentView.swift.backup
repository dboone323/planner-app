//
//  ContentView.swift
//  CodingReviewer
//
//  Main content view for the CodingReviewer application
//

import SwiftUI
import os
import UniformTypeIdentifiers

enum ContentViewType {
    case analysis, documentation, tests
}

struct ContentView: View {
    private let logger = Logger(subsystem: "com.quantum.codingreviewer", category: "ContentView")

    // Service layer
    private let codeReviewService = CodeReviewService()

    @State private var selectedFileURL: URL?
    @State private var codeContent: String = ""
    @State private var analysisResult: CodeAnalysisResult?
    @State private var documentationResult: DocumentationResult?
    @State private var testResult: TestGenerationResult?
    @State private var isAnalyzing = false
    @State private var showFilePicker = false
    @State private var selectedAnalysisType: AnalysisType = .comprehensive
    @State private var currentView: ContentViewType = .analysis

    var body: some View {
        NavigationSplitView {
            // Sidebar with file browser and analysis tools
            SidebarView(
                selectedFileURL: $selectedFileURL,
                showFilePicker: $showFilePicker,
                selectedAnalysisType: $selectedAnalysisType,
                currentView: $currentView
            )
        } detail: {
            // Main content area
            ZStack {
                if let fileURL = selectedFileURL {
                    CodeReviewView(
                        fileURL: fileURL,
                        codeContent: $codeContent,
                        analysisResult: $analysisResult,
                        documentationResult: $documentationResult,
                        testResult: $testResult,
                        isAnalyzing: $isAnalyzing,
                        selectedAnalysisType: selectedAnalysisType,
                        currentView: currentView,
                        onAnalyze: { await analyzeCode() },
                        onGenerateDocumentation: { await generateDocumentation() },
                        onGenerateTests: { await generateTests() }
                    )
                } else {
                    WelcomeView(showFilePicker: $showFilePicker)
                }
            }
        }
        .fileImporter(
            isPresented: $showFilePicker,
            allowedContentTypes: [.swiftSource, .objectiveCSource, .cSource, .cHeader],
            allowsMultipleSelection: false
        ) { result in
            handleFileSelection(result)
        }
        .onAppear {
            logger.info("ContentView appeared")
        }
    }

    private func handleFileSelection(_ result: Result<[URL], Error>) {
        switch result {
        case .success(let urls):
            if let url = urls.first {
                selectedFileURL = url
                loadFileContent(from: url)
            }
        case .failure(let error):
            logger.error("File selection failed: \(error.localizedDescription)")
            // TODO: Handle error properly
        }
    }

    private func loadFileContent(from url: URL) {
        do {
            let content = try String(contentsOf: url, encoding: .utf8)
            codeContent = content
            logger.info("Loaded file content from: \(url.lastPathComponent)")
        } catch {
            logger.error("Failed to load file content: \(error.localizedDescription)")
            // TODO: Handle error properly
        }
    }

    private func analyzeCode() async {
        guard !codeContent.isEmpty else { return }

        isAnalyzing = true
        defer { isAnalyzing = false }

        do {
            let language = detectLanguage(from: selectedFileURL)
            let result = try await codeReviewService.analyzeCode(codeContent, language: language, analysisType: selectedAnalysisType)
            analysisResult = result
            logger.info("Code analysis completed successfully")
        } catch {
            logger.error("Code analysis failed: \(error.localizedDescription)")
            // TODO: Handle error properly
        }
    }

    private func generateDocumentation() async {
        guard !codeContent.isEmpty else { return }

        isAnalyzing = true
        defer { isAnalyzing = false }

        do {
            let language = detectLanguage(from: selectedFileURL)
            let result = try await codeReviewService.generateDocumentation(codeContent, language: language, includeExamples: true)
            documentationResult = result
            logger.info("Documentation generation completed successfully")
        } catch {
            logger.error("Documentation generation failed: \(error.localizedDescription)")
            // TODO: Handle error properly
        }
    }

    private func generateTests() async {
        guard !codeContent.isEmpty else { return }

        isAnalyzing = true
        defer { isAnalyzing = false }

        do {
            let language = detectLanguage(from: selectedFileURL)
            let result = try await codeReviewService.generateTests(codeContent, language: language, testFramework: "XCTest")
            testResult = result
            logger.info("Test generation completed successfully")
        } catch {
            logger.error("Test generation failed: \(error.localizedDescription)")
            // TODO: Handle error properly
        }
    }

    private func detectLanguage(from url: URL?) -> String {
        guard let url = url else { return "Swift" }

        let pathExtension = url.pathExtension.lowercased()
        switch pathExtension {
        case "swift": return "Swift"
        case "py": return "Python"
        case "js", "ts": return "JavaScript"
        case "java": return "Java"
        case "cpp", "cc", "cxx": return "C++"
        case "c": return "C"
        case "h": return "C/C++ Header"
        case "m": return "Objective-C"
        case "rb": return "Ruby"
        case "php": return "PHP"
        case "go": return "Go"
        case "rs": return "Rust"
        default: return "Swift" // Default to Swift
        }
    }
}
    private let logger = Logger(subsystem: "com.quantum.codingreviewer", category: "ContentView")

    // Service layer
    private let codeReviewService = CodeReviewService()

    @State private var selectedFileURL: URL?
    @State private var codeContent: String = ""
    @State private var analysisResult: CodeAnalysisResult?
    @State private var documentationResult: DocumentationResult?
    @State private var testResult: TestGenerationResult?
    @State private var isAnalyzing = false
    @State private var showFilePicker = false
    @State private var selectedAnalysisType: AnalysisType = .comprehensive
    @State private var currentView: ContentViewType = .analysis

    var body: some View {
        NavigationSplitView {
            // Sidebar with file browser and analysis tools
            SidebarView(
                selectedFileURL: $selectedFileURL,
                showFilePicker: $showFilePicker,
                selectedAnalysisType: $selectedAnalysisType,
                currentView: $currentView
            )
        } detail: {
            // Main content area
            ZStack {
                if let fileURL = selectedFileURL {
                    CodeReviewView(
                        fileURL: fileURL,
                        codeContent: $codeContent,
                        analysisResult: $analysisResult,
                        documentationResult: $documentationResult,
                        testResult: $testResult,
                        isAnalyzing: $isAnalyzing,
                        selectedAnalysisType: selectedAnalysisType,
                        currentView: currentView,
                        onAnalyze: { await analyzeCode() },
                        onGenerateDocumentation: { await generateDocumentation() },
                        onGenerateTests: { await generateTests() }
                    )
                } else {
                    WelcomeView(showFilePicker: $showFilePicker)
                }
            }
        }
        .fileImporter(
            isPresented: $showFilePicker,
            allowedContentTypes: [.swiftSource, .objectiveCSource, .cSource, .cHeader],
            allowsMultipleSelection: false
        ) { result in
            handleFileSelection(result)
        }
        .onAppear {
            logger.info("ContentView appeared")
        }
    }

    private func handleFileSelection(_ result: Result<[URL], Error>) {
        switch result {
        case .success(let urls):
            if let url = urls.first {
                selectedFileURL = url
                loadFileContent(from: url)
            }
        case .failure(let error):
            logger.error("File selection failed: \(error.localizedDescription)")
            // TODO: Handle error properly
        }
    }

    private func loadFileContent(from url: URL) {
        do {
            let content = try String(contentsOf: url, encoding: .utf8)
            codeContent = content
            logger.info("Loaded file content from: \(url.lastPathComponent)")
        } catch {
            logger.error("Failed to load file content: \(error.localizedDescription)")
            // TODO: Handle error properly
        }
    }

    private func analyzeCode() async {
        guard !codeContent.isEmpty else { return }

        isAnalyzing = true
        defer { isAnalyzing = false }

        do {
            let language = detectLanguage(from: selectedFileURL)
            let result = try await codeReviewService.analyzeCode(codeContent, language: language, analysisType: selectedAnalysisType)
            analysisResult = result
            logger.info("Code analysis completed successfully")
        } catch {
            logger.error("Code analysis failed: \(error.localizedDescription)")
            // TODO: Handle error properly
        }
    }

    private func generateDocumentation() async {
        guard !codeContent.isEmpty else { return }

        isAnalyzing = true
        defer { isAnalyzing = false }

        do {
            let language = detectLanguage(from: selectedFileURL)
            let result = try await codeReviewService.generateDocumentation(codeContent, language: language, includeExamples: true)
            documentationResult = result
            logger.info("Documentation generation completed successfully")
        } catch {
            logger.error("Documentation generation failed: \(error.localizedDescription)")
            // TODO: Handle error properly
        }
    }

    private func generateTests() async {
        guard !codeContent.isEmpty else { return }

        isAnalyzing = true
        defer { isAnalyzing = false }

        do {
            let language = detectLanguage(from: selectedFileURL)
            let result = try await codeReviewService.generateTests(codeContent, language: language, testFramework: "XCTest")
            testResult = result
            logger.info("Test generation completed successfully")
        } catch {
            logger.error("Test generation failed: \(error.localizedDescription)")
            // TODO: Handle error properly
        }
    }

    private func detectLanguage(from url: URL?) -> String {
        guard let url = url else { return "Swift" }

        let pathExtension = url.pathExtension.lowercased()
        switch pathExtension {
        case "swift": return "Swift"
        case "py": return "Python"
        case "js", "ts": return "JavaScript"
        case "java": return "Java"
        case "cpp", "cc", "cxx": return "C++"
        case "c": return "C"
        case "h": return "C/C++ Header"
        case "m": return "Objective-C"
        case "rb": return "Ruby"
        case "php": return "PHP"
        case "go": return "Go"
        case "rs": return "Rust"
        default: return "Swift" // Default to Swift
        }
    }
}

// MARK: - Preview

struct ContentView_Previews: PreviewProvider {
    static var previews: some View {
        ContentView()
    }
}
