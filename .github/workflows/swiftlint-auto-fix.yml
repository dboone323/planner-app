name: SwiftLint Auto-Fix

on:
    schedule:
        # Run daily at 01:00 UTC (after nightly cleanup)
        - cron: "0 1 * * *"
    workflow_dispatch:
        inputs:
            project:
                description: 'Project to fix (or "all")'
                required: false
                default: "all"

jobs:
    swiftlint-autofix:
        runs-on: macos-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4
              with:
                  token: ${{ secrets.GITHUB_TOKEN }}
                  fetch-depth: 0

            - name: Setup Swift
              uses: swift-actions/setup-swift@v2
              with:
                  swift-version: "5.9"

            - name: Install SwiftLint
              run: |
                  brew install swiftlint || brew upgrade swiftlint
                  swiftlint version

            - name: Run SwiftLint Auto-Fix on AvoidObstaclesGame
              if: github.event.inputs.project == 'all' || github.event.inputs.project == 'AvoidObstaclesGame'
              run: |
                  cd Projects/AvoidObstaclesGame
                  if [[ -f .swiftlint.yml ]]; then
                    echo "Running SwiftLint auto-fix for AvoidObstaclesGame..."
                    swiftlint --fix --format --quiet || true
                  fi
              continue-on-error: true

            - name: Run SwiftLint Auto-Fix on HabitQuest
              if: github.event.inputs.project == 'all' || github.event.inputs.project == 'HabitQuest'
              run: |
                  cd Projects/HabitQuest
                  if [[ -f .swiftlint.yml ]]; then
                    echo "Running SwiftLint auto-fix for HabitQuest..."
                    swiftlint --fix --format --quiet || true
                  fi
              continue-on-error: true

            - name: Run SwiftLint Auto-Fix on MomentumFinance
              if: github.event.inputs.project == 'all' || github.event.inputs.project == 'MomentumFinance'
              run: |
                  cd Projects/MomentumFinance
                  if [[ -f .swiftlint.yml ]]; then
                    echo "Running SwiftLint auto-fix for MomentumFinance..."
                    swiftlint --fix --format --quiet || true
                  fi
              continue-on-error: true

            - name: Run SwiftLint Auto-Fix on PlannerApp
              if: github.event.inputs.project == 'all' || github.event.inputs.project == 'PlannerApp'
              run: |
                  cd Projects/PlannerApp
                  if [[ -f .swiftlint.yml ]]; then
                    echo "Running SwiftLint auto-fix for PlannerApp..."
                    swiftlint --fix --format --quiet || true
                  fi
              continue-on-error: true

            - name: Run SwiftLint Auto-Fix on CodingReviewer
              if: github.event.inputs.project == 'all' || github.event.inputs.project == 'CodingReviewer'
              run: |
                  cd Projects/CodingReviewer
                  if [[ -f .swiftlint.yml ]]; then
                    echo "Running SwiftLint auto-fix for CodingReviewer..."
                    swiftlint --fix --format --quiet || true
                  fi
              continue-on-error: true

            - name: Run SwiftFormat on Shared Components
              run: |
                  if command -v swiftformat &>/dev/null; then
                    echo "Running SwiftFormat on Shared components..."
                    swiftformat Shared --config .swiftformat || true
                  fi
              continue-on-error: true

            - name: Check for changes
              id: check_changes
              run: |
                  git config --global user.name "GitHub Actions Bot"
                  git config --global user.email "actions@github.com"

                  if git diff --quiet; then
                    echo "changes=false" >> $GITHUB_OUTPUT
                    echo "No changes to commit"
                  else
                    echo "changes=true" >> $GITHUB_OUTPUT
                    echo "Changes detected:"
                    git diff --stat
                  fi

            - name: Commit and push changes
              if: steps.check_changes.outputs.changes == 'true'
              run: |
                  git add .
                  git commit -m "chore(lint): auto-fix SwiftLint violations [skip ci]

                  - Applied SwiftLint auto-fix across all projects
                  - Fixed formatting issues
                  - Automated by nightly SwiftLint workflow"

                  git push origin main
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

            - name: Generate summary
              run: |
                  echo "## SwiftLint Auto-Fix Summary" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "**Status:** Completed successfully" >> $GITHUB_STEP_SUMMARY
                  echo "**Changes committed:** ${{ steps.check_changes.outputs.changes }}" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY

                  if [[ "${{ steps.check_changes.outputs.changes }}" == "true" ]]; then
                    echo "### Files Modified" >> $GITHUB_STEP_SUMMARY
                    git diff --name-only HEAD~1 >> $GITHUB_STEP_SUMMARY || echo "Unable to list files" >> $GITHUB_STEP_SUMMARY
                  fi
