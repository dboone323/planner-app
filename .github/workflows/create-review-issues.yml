name: Create Review Issues
"on":
  push:
    branches: [ main ]

permissions:
  issues: write
  contents: read

jobs:
  create-issues:
    name: Create review issues from templates
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Read issue templates
        id: read
        run: |
          echo "::set-output name=files::$(ls .github/review-issues || true)"

      - name: Create issues
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const path = '.github/review-issues';
            const files = fs.readdirSync(path).filter(f => f.endsWith('.md')).sort();
            for (const file of files) {
              const content = fs.readFileSync(path + '/' + file, 'utf8');
              // Extract title from the second line (after the ---)
              const lines = content.split(/\r?\n/).filter(Boolean);
              let title = file.replace(/\.md$/,'');
              // Look for title on the second line (after ---)
              if (lines.length > 1 && lines[1].length < 200) {
                title = lines[1].replace(/^#*/,'').trim();
              }

              // Check if an open or closed issue with same title already exists
              const existing = await github.rest.issues.listForRepo({
                owner: context.repo.owner,
                repo: context.repo.repo,
                state: 'all',
                per_page: 100
              });
              const found = existing.data.find(i => i.title === title);
              if (found) {
                console.log(`Issue with title '${title}' already exists (#${found.number}), skipping`);
                continue;
              }

              console.log(`Creating issue: ${title}`);
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: content,
                assignees: ['dboone323'],
                labels: ['workspace-review']
              });
            }