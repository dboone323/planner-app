name: Weekly Health Check

on:
    schedule:
        # Run every Sunday at 02:00 UTC
        - cron: "0 2 * * 0"
    workflow_dispatch:

permissions:
    contents: write

jobs:
    weekly-health-check:
        name: Weekly System Health Check
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Install dependencies
              run: |
                  sudo apt-get update
                  sudo apt-get install -y jq curl

            - name: Run weekly health check
              run: |
                  bash Tools/Automation/observability/weekly_health_check.sh

            - name: Upload health report
              uses: actions/upload-artifact@v4
              with:
                  name: weekly-health-report-${{ github.run_id }}
                  path: Tools/Automation/reports/weekly_health_report_*.md
                  retention-days: 90

            - name: Commit health report
              continue-on-error: true
              run: |
                  git config --local user.email "github-actions[bot]@users.noreply.github.com"
                  git config --local user.name "github-actions[bot]"

                  git add Tools/Automation/reports/weekly_health_report_*.md

                  if git diff --staged --quiet; then
                    echo "No report changes to commit"
                  else
                    git commit -m "docs: weekly health check report [skip ci]"
                    git push origin HEAD
                  fi

            - name: Check for critical issues
              id: check_critical
              run: |
                  REPORT_FILE=$(ls -t Tools/Automation/reports/weekly_health_report_*.md | head -1)

                  if grep -q "ðŸ”´ CRITICAL" "$REPORT_FILE"; then
                    echo "critical=true" >> $GITHUB_OUTPUT
                    echo "::warning::CRITICAL issues detected in weekly health check"
                  else
                    echo "critical=false" >> $GITHUB_OUTPUT
                  fi

            - name: Post summary
              run: |
                  REPORT_FILE=$(ls -t Tools/Automation/reports/weekly_health_report_*.md | head -1)

                  echo "## ðŸ“Š Weekly Health Check Summary" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  cat "$REPORT_FILE" >> $GITHUB_STEP_SUMMARY

            - name: Create issue for critical problems
              if: steps.check_critical.outputs.critical == 'true'
              uses: actions/github-script@v7
              with:
                  script: |
                      const fs = require('fs');
                      const reportFiles = fs.readdirSync('Tools/Automation/reports')
                        .filter(f => f.startsWith('weekly_health_report_'))
                        .sort()
                        .reverse();

                      if (reportFiles.length === 0) return;

                      const reportContent = fs.readFileSync(
                        `Tools/Automation/reports/${reportFiles[0]}`,
                        'utf8'
                      );

                      await github.rest.issues.create({
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        title: 'ðŸ”´ CRITICAL: Weekly Health Check Detected Issues',
                        body: `## Automated Critical Issue Report\n\n${reportContent}\n\n---\n*Automatically created by weekly health check workflow*`,
                        labels: ['critical', 'automated', 'health-check']
                      });
