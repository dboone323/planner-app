name: PR Validation (Unified)

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  # Phase 1: Always run basic checks (from pr-validation.yml)
  basic-validation:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.x"

      - name: Run basic repository checks
        run: |
          echo "âœ… Repository validation checks"
          # Basic sanity checks can be added here

      - name: Enforce no production TODO/FIXME markers
        run: |
          if [ -f Tools/Automation/ci_guard_no_todos.sh ]; then
            bash Tools/Automation/ci_guard_no_todos.sh
          else
            echo "âš ï¸  ci_guard_no_todos.sh not found, skipping TODO check"
          fi

      - name: Upload validation log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pr-validation-basic-log
          path: |
            .
            !.git
          retention-days: 5

  # Phase 2: Conditional automation/workflow validation (from validate-and-lint-pr.yml)
  automation-validation:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check changed files
        uses: dorny/paths-filter@4512585405083f25c027a35db413c2b3b9006d50 # v2
        id: filter
        with:
          filters: |
            automation:
              - 'Tools/Automation/**'
              - '.github/workflows/**'

      - name: Set up Python
        if: steps.filter.outputs.automation == 'true'
        uses: actions/setup-python@v4
        with:
          python-version: "3.x"

      - name: Install PyYAML
        if: steps.filter.outputs.automation == 'true'
        run: |
          python -m pip install --upgrade pip
          python -m pip install pyyaml

      - name: Install ShellCheck
        if: steps.filter.outputs.automation == 'true'
        run: |
          if [ "$(uname)" == "Darwin" ]; then
            brew install shellcheck || true
          else
            sudo apt-get update && sudo apt-get install -y shellcheck
          fi

      - name: Bash syntax check
        if: steps.filter.outputs.automation == 'true'
        run: |
          echo "ðŸ” Checking bash syntax for automation scripts..."
          if [ -f Tools/Automation/master_automation.sh ]; then
            bash -n Tools/Automation/master_automation.sh && echo "âœ… master_automation.sh syntax OK"
          fi
          if [ -f Tools/Automation/deploy_workflows_all_projects.sh ]; then
            bash -n Tools/Automation/deploy_workflows_all_projects.sh && echo "âœ… deploy_workflows_all_projects.sh syntax OK"
          fi

      - name: Run ShellCheck
        if: steps.filter.outputs.automation == 'true'
        run: |
          echo "ðŸ” Running ShellCheck on automation scripts..."
          if [ -f Tools/Automation/master_automation.sh ]; then
            shellcheck Tools/Automation/master_automation.sh || true
          fi
          if [ -f Tools/Automation/deploy_workflows_all_projects.sh ]; then
            shellcheck Tools/Automation/deploy_workflows_all_projects.sh || true
          fi
          echo "âœ… ShellCheck complete"

      - name: Run deploy validation
        if: steps.filter.outputs.automation == 'true'
        run: |
          if [ -f Tools/Automation/deploy_workflows_all_projects.sh ]; then
            bash Tools/Automation/deploy_workflows_all_projects.sh --validate || echo "âš ï¸  Validation completed with warnings"
          else
            echo "â„¹ï¸  deploy_workflows_all_projects.sh not found"
          fi
        env:
          CODE_DIR: ${{ github.workspace }}

      - name: Run master automation list (safe check)
        run: |
          if [ -f Tools/Automation/master_automation.sh ]; then
            bash Tools/Automation/master_automation.sh list || true
            echo "âœ… Master automation list complete"
          else
            echo "â„¹ï¸  master_automation.sh not found"
          fi

      - name: Validate workflow YAML syntax
        run: |
          echo "ðŸ” Validating GitHub Actions workflow YAML..."
          for workflow in .github/workflows/*.yml; do
            if [ -f "$workflow" ]; then
              echo "Checking $workflow..."
              python -c "import yaml; yaml.safe_load(open('$workflow'))" && echo "  âœ… Valid" || echo "  âŒ Invalid"
            fi
          done

  # Phase 3: Summary job
  validation-summary:
    needs: [basic-validation, automation-validation]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Generate Summary
        run: |
          echo "## ðŸ“‹ PR Validation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Basic Validation" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** ${{ needs.basic-validation.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Automation Validation" >> $GITHUB_STEP_SUMMARY
          if [ "${{ needs.automation-validation.result }}" == "skipped" ]; then
            echo "**Status:** â­ï¸ Skipped (no automation/workflow changes)" >> $GITHUB_STEP_SUMMARY
          else
            echo "**Status:** ${{ needs.automation-validation.result }}" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

          # Determine overall status
          if [ "${{ needs.basic-validation.result }}" == "failure" ]; then
            echo "### âŒ Overall Result: FAILED" >> $GITHUB_STEP_SUMMARY
            echo "Basic validation checks failed. Please review and fix." >> $GITHUB_STEP_SUMMARY
            exit 1
          elif [ "${{ needs.automation-validation.result }}" == "failure" ]; then
            echo "### âŒ Overall Result: FAILED" >> $GITHUB_STEP_SUMMARY
            echo "Automation validation checks failed. Please review and fix." >> $GITHUB_STEP_SUMMARY
            exit 1
          else
            echo "### âœ… Overall Result: PASSED" >> $GITHUB_STEP_SUMMARY
            echo "All validation checks passed successfully!" >> $GITHUB_STEP_SUMMARY
          fi
