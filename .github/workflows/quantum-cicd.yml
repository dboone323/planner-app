name: ğŸš€ Quantum CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production

env:
  DEVELOPER_DIR: /Applications/Xcode_15.4.app/Contents/Developer

jobs:
  # Code Quality Checks
  quality-checks:
    name: ğŸ” Code Quality
    runs-on: macos-14
    timeout-minutes: 15

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: ğŸ”§ Setup Swift
        uses: swift-actions/setup-swift@v2
        with:
          swift-version: '6.0'

      - name: ğŸ“¦ Cache Dependencies
        uses: actions/cache@v4
        with:
          path: |
            .build
            ~/Library/Caches/org.swift.swiftpm
          key: ${{ runner.os }}-spm-${{ hashFiles('**/Package.resolved') }}
          restore-keys: |
            ${{ runner.os }}-spm-

      - name: ğŸ¨ SwiftFormat Check
        run: |
          if command -v swiftformat >/dev/null 2>&1; then
            swiftformat . --config .swiftformat --lint --verbose
          else
            echo "âš ï¸ SwiftFormat not found, skipping format check"
          fi

      - name: ğŸ” SwiftLint
        run: |
          if command -v swiftlint >/dev/null 2>&1; then
            swiftlint --strict --reporter github-actions-logging
          else
            echo "âš ï¸ SwiftLint not found, skipping lint check"
          fi

      - name: ğŸ“ Check Line Length
        run: |
          MAX_LENGTH=150
          VIOLATIONS=$(find . -name "*.swift" -not -path "./.build/*" -not -path "./DerivedData/*" -exec awk 'length > '$MAX_LENGTH' {print FILENAME":"NR":"$0}' {} \;)
          if [ -n "$VIOLATIONS" ]; then
            echo "âŒ Lines exceed $MAX_LENGTH characters:"
            echo "$VIOLATIONS"
            exit 1
          else
            echo "âœ… All lines within $MAX_LENGTH characters"
          fi

  # Multi-Platform Build & Test
  build-and-test:
    name: ğŸ—ï¸ Build & Test
    runs-on: macos-14
    timeout-minutes: 45
    needs: quality-checks
    strategy:
      fail-fast: false
      matrix:
        include:
          - destination: "platform=iOS Simulator,name=iPhone 17,OS=17.5"
            name: iOS
            scheme: PlannerApp
          - destination: "platform=macOS"
            name: macOS
            scheme: PlannerApp

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v6

      - name: ğŸ”§ Setup Swift
        uses: swift-actions/setup-swift@v2
        with:
          swift-version: '6.0'

      - name: ğŸ“¦ Cache DerivedData
        uses: actions/cache@v4
        with:
          path: ~/Library/Developer/Xcode/DerivedData
          key: ${{ runner.os }}-deriveddata-${{ hashFiles('**/*.swift', '**/*.xcodeproj') }}
          restore-keys: |
            ${{ runner.os }}-deriveddata-

      - name: ğŸ—ï¸ Build (${{ matrix.name }})
        run: |
          echo "ğŸ”¨ Building ${{ matrix.name }}..."
          xcodebuild build \
            -scheme ${{ matrix.scheme }} \
            -destination '${{ matrix.destination }}' \
            -configuration Debug \
            -enableCodeCoverage YES \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            SWIFT_TREAT_WARNINGS_AS_ERRORS=YES

      - name: ğŸ§ª Run Tests (${{ matrix.name }})
        run: |
          echo "ğŸ§ª Running tests on ${{ matrix.name }}..."
          xcodebuild test \
            -scheme ${{ matrix.scheme }} \
            -destination '${{ matrix.destination }}' \
            -configuration Debug \
            -enableCodeCoverage YES \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            -resultBundlePath TestResults.xcresult

      - name: ğŸ“Š Upload Test Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results-${{ matrix.name }}
          path: TestResults.xcresult
          retention-days: 30

      - name: ğŸ“ˆ Generate Coverage Report
        if: matrix.name == 'iOS'
        run: |
          echo "ğŸ“Š Generating code coverage report..."
          xcrun xccov view --report --json TestResults.xcresult > coverage.json || true

      - name: ğŸ“¤ Upload Coverage
        if: matrix.name == 'iOS'
        uses: codecov/codecov-action@v4
        with:
          file: ./coverage.json
          flags: ios
          name: codecov-umbrella
          fail_ci_if_error: false

  # Security Scanning
  security-scan:
    name: ğŸ”’ Security Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: quality-checks

    permissions:
      contents: read
      security-events: write

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: ğŸ›¡ï¸ Run Trivy Vulnerability Scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
          ignore-unfixed: true

      - name: ğŸ“¤ Upload Trivy Results
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

      - name: ğŸ” Check for Secrets (PR)
        if: github.event_name == 'pull_request'
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.pull_request.base.sha }}
          head: ${{ github.event.pull_request.head.sha }}
          extra_args: --debug --only-verified

      - name: ğŸ” Check for Secrets (Push)
        if: github.event_name == 'push'
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          extra_args: --debug --only-verified

  # Performance Testing
  performance-test:
    name: âš¡ Performance Analysis
    runs-on: macos-14
    timeout-minutes: 30
    needs: build-and-test

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v6

      - name: ğŸ”§ Setup Swift
        uses: swift-actions/setup-swift@v2
        with:
          swift-version: '6.0'

      - name: ğŸ“¦ Cache DerivedData
        uses: actions/cache@v4
        with:
          path: ~/Library/Developer/Xcode/DerivedData
          key: ${{ runner.os }}-deriveddata-${{ hashFiles('**/*.swift', '**/*.xcodeproj') }}
          restore-keys: |
            ${{ runner.os }}-deriveddata-

      - name: ğŸ—ï¸ Build for Performance Testing
        run: |
          xcodebuild build \
            -scheme PlannerApp \
            -destination 'platform=iOS Simulator,name=iPhone 17,OS=17.5' \
            -configuration Release \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO

      - name: âš¡ Run Performance Tests
        run: |
          echo "ğŸƒ Running performance benchmarks..."
          # Run performance tests if they exist
          if xcodebuild test -scheme PlannerApp -destination 'platform=iOS Simulator,name=iPhone 17,OS=17.5' -configuration Release -only-testing:PlannerAppTests/PerformanceTests 2>/dev/null; then
            echo "âœ… Performance tests completed"
          else
            echo "âš ï¸ No performance tests found, skipping"
          fi

      - name: ğŸ“Š Analyze Build Performance
        run: |
          echo "ğŸ“ˆ Build performance analysis..."
          # Add build time analysis here
          echo "âœ… Build performance analysis completed"

  # Deployment Preparation
  prepare-deployment:
    name: ğŸš€ Prepare Deployment
    runs-on: macos-14
    timeout-minutes: 20
    needs: [build-and-test, security-scan, performance-test]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v6

      - name: ğŸ”§ Setup Swift
        uses: swift-actions/setup-swift@v2
        with:
          swift-version: '6.0'

      - name: ğŸ—ï¸ Build Release
        run: |
          echo "ğŸ—ï¸ Building release version..."
          xcodebuild build \
            -scheme PlannerApp \
            -destination 'platform=iOS Simulator,name=iPhone 17,OS=17.5' \
            -configuration Release \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO

      - name: ğŸ“¦ Prepare Artifacts
        run: |
          echo "ğŸ“¦ Preparing deployment artifacts..."
          mkdir -p artifacts
          # Copy build artifacts
          cp -r PlannerApp.xcodeproj artifacts/ || true
          echo "âœ… Artifacts prepared"

      - name: ğŸ“¤ Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: planner-app-release-artifacts
          path: artifacts/
          retention-days: 30

  # Final Quality Gate
  quality-gate:
    name: âœ… Quality Gate
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: [quality-checks, build-and-test, security-scan, performance-test]
    if: always()

    steps:
      - name: ğŸ“Š Quality Gate Check
        run: |
          echo "ğŸ” Evaluating quality gate status..."

          # Check if all required jobs passed
          if [ "${{ needs.quality-checks.result }}" = "success" ] && \
             [ "${{ needs.build-and-test.result }}" = "success" ] && \
             [ "${{ needs.security-scan.result }}" = "success" ]; then
            echo "âœ… All quality checks passed!"
            echo "ğŸ‰ Ready for deployment"
            exit 0
          else
            echo "âŒ Quality gate failed"
            echo "Quality Checks: ${{ needs.quality-checks.result }}"
            echo "Build & Test: ${{ needs.build-and-test.result }}"
            echo "Security Scan: ${{ needs.security-scan.result }}"
            echo "Performance Test: ${{ needs.performance-test.result }}"
            exit 1
          fi