name: Test Coverage & Quality Gates

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test-coverage:
    name: Test Coverage Analysis
    runs-on: macos-latest
    strategy:
      fail-fast: false
      matrix:
        project:
          [
            AvoidObstaclesGame,
            HabitQuest,
            MomentumFinance,
            PlannerApp,
            CodingReviewer,
          ]
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Cache Swift Package Manager
        uses: actions/cache@v4
        with:
          path: |
            ~/.swiftpm
            .build
          key: spm-${{ runner.os }}-${{ matrix.project }}-${{ hashFiles('Projects/${{ matrix.project }}/Package.resolved') }}
          restore-keys: spm-${{ runner.os }}-

      - name: Install Swift tools
        run: |
          brew install swiftlint swiftlint || true
          swiftformat --version
          swiftlint version || true

      - name: Generate Test Coverage
        if: hashFiles('Projects/${{ matrix.project }}/Package.swift') != ''
        run: |
          cd Projects/${{ matrix.project }}
          swift test --enable-code-coverage
          # Generate coverage report if xccov is available
          if command -v xcrun &> /dev/null; then
            xcrun llvm-cov export -format="lcov" .build/debug/${{ matrix.project }}PackageTests.xctest/Contents/MacOS/${{ matrix.project }}PackageTests > coverage.lcov || true
          fi

      - name: Upload Coverage Reports
        if: always()
        uses: codecov/codecov-action@v4
        with:
          file: ./Projects/${{ matrix.project }}/coverage.lcov
          flags: ${{ matrix.project }}
          name: ${{ matrix.project }} Coverage
          fail_ci_if_error: false

  quality-gates:
    name: Quality Gates
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Quality Tools
        run: |
          brew install swiftlint swiftformat || true
          pip install radon mccabe

      - name: Run Quality Analysis
        run: |
          echo "## Quality Gate Analysis" > quality_report.md
          echo "" >> quality_report.md

          # SwiftLint Analysis
          echo "### SwiftLint Results" >> quality_report.md
          swiftlint lint --config Tools/Config/UNIFIED_SWIFTLINT_ROOT.yml --path Projects/ --reporter json > swiftlint_results.json || true

          # Count violations by severity
          if [ -f swiftlint_results.json ]; then
            WARNINGS=$(jq '[.[] | select(.severity == "Warning")] | length' swiftlint_results.json)
            ERRORS=$(jq '[.[] | select(.severity == "Error")] | length' swiftlint_results.json)
            echo "- Warnings: $WARNINGS" >> quality_report.md
            echo "- Errors: $ERRORS" >> quality_report.md
          else
            echo "- No SwiftLint results available" >> quality_report.md
          fi

          # Code Complexity Analysis
          echo "" >> quality_report.md
          echo "### Code Complexity" >> quality_report.md
          find Projects -name "*.swift" -exec wc -l {} \; | awk '{if ($1 > 500) print "- " $2 ": " $1 " lines (EXCEEDS LIMIT)"}' >> quality_report.md

          # Test Coverage Summary
          echo "" >> quality_report.md
          echo "### Test Coverage Summary" >> quality_report.md
          echo "- Unit Tests: $(find Projects -name "*Test*.swift" | wc -l) files" >> quality_report.md
          echo "- UI Tests: $(find Projects -name "*UITest*.swift" | wc -l) files" >> quality_report.md

      - name: Upload Quality Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: quality-report
          path: quality_report.md

  integration-tests:
    name: Integration Tests
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Run Master Test Suite
        run: |
          chmod +x run_master_test_suite.sh
          ./run_master_test_suite.sh

      - name: Upload Test Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-reports
          path: |
            COMPREHENSIVE_TEST_REPORT_*.md
            test_results_*.log
