name: Nightly Hygiene & Observability

on:
    schedule:
        # Run daily at midnight UTC
        - cron: "0 0 * * *"
    workflow_dispatch:
        inputs:
            dry_run:
                description: "Dry run mode (no actual deletions)"
                required: false
                type: boolean
                default: true

permissions:
    contents: write
    pull-requests: read

jobs:
    health-check:
        name: System Health Check
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0 # Full history for branch analysis

            - name: Install dependencies
              run: |
                  sudo apt-get update
                  sudo apt-get install -y jq curl

            - name: Setup Ollama
              continue-on-error: true
              run: |
                  # Install Ollama using official installer with version pinning
                  curl -fsSL https://ollama.com/install.sh -o /tmp/ollama-install.sh
                  # Verify script exists and has content
                  if [[ -s /tmp/ollama-install.sh ]]; then
                    sh /tmp/ollama-install.sh || true
                  fi

            - name: Start Ollama in background
              continue-on-error: true
              run: |
                  ollama serve > /dev/null 2>&1 &
                  sleep 5

                  # Check if Ollama is running
                  if curl -sf --max-time 5 http://localhost:11434/api/tags > /dev/null 2>&1; then
                    echo "OLLAMA_AVAILABLE=true" >> $GITHUB_ENV
                  else
                    echo "OLLAMA_AVAILABLE=false" >> $GITHUB_ENV
                  fi

            - name: Run Watchdog Monitor
              id: watchdog
              continue-on-error: true
              env:
                  DISK_USAGE_THRESHOLD: 85
                  ERROR_THRESHOLD: 3
                  TIME_WINDOW_MINUTES: 60
              run: |
                  bash Tools/Automation/observability/watchdog.sh || true

            - name: Collect Metrics Snapshot
              id: metrics
              run: |
                  bash Tools/Automation/observability/metrics_snapshot.sh

            - name: Upload metrics snapshot
              uses: actions/upload-artifact@v4
              with:
                  name: metrics-snapshot-${{ github.run_id }}
                  path: Tools/Automation/metrics/snapshots/*.json
                  retention-days: 90

            - name: Check health status
              run: |
                  echo "Health check completed"
                  echo "Watchdog status: ${{ steps.watchdog.outcome }}"
                  echo "Metrics status: ${{ steps.metrics.outcome }}"

    log-rotation:
        name: Log Rotation & Cleanup
        runs-on: ubuntu-latest
        needs: health-check

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Install dependencies
              run: |
                  sudo apt-get update
                  sudo apt-get install -y jq curl

            - name: Rotate logs
              run: |
                  bash Tools/Automation/observability/rotate_logs.sh

            - name: Commit rotated logs
              continue-on-error: true
              run: |
                  git config --local user.email "github-actions[bot]@users.noreply.github.com"
                  git config --local user.name "github-actions[bot]"

                  # Add rotated/compressed logs if any
                  git add Tools/Automation/**/*.log.*.gz 2>/dev/null || true

                  if git diff --staged --quiet; then
                    echo "No logs to commit"
                  else
                    git commit -m "chore: automated log rotation [skip ci]"
                    git push origin HEAD || echo "Push failed (may not have changes)"
                  fi

    branch-cleanup:
        name: Branch Cleanup
        runs-on: ubuntu-latest
        needs: health-check

        steps:
            - name: Checkout code
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0 # Need full history

            - name: Setup cleanup environment
              run: |
                  git config --local user.email "github-actions[bot]@users.noreply.github.com"
                  git config --local user.name "github-actions[bot]"

                  # Fetch all branches
                  git fetch --all --prune

            - name: Run branch cleanup
              env:
                  BRANCH_AGE_DAYS: 7
                  DRY_RUN: ${{ github.event.inputs.dry_run || 'true' }}
              run: |
                  bash Tools/Automation/hygiene/cleanup_branches.sh

            - name: Summary
              run: |
                  echo "Branch cleanup completed"
                  echo "Dry run mode: ${{ github.event.inputs.dry_run || 'true' }}"
                  echo "Deleted branches are logged above"

    artifact-cleanup:
        name: Artifact Cleanup
        runs-on: ubuntu-latest
        needs: health-check

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Clean old validation reports
              run: |
                  echo "Cleaning validation reports older than 30 days..."
                  find Tools/Automation -name "*validation_report*.md" -mtime +30 -delete || true
                  find Tools/Automation -name "*validation_report*.json" -mtime +30 -delete || true

            - name: Clean old AI review artifacts
              run: |
                  echo "Cleaning AI review artifacts older than 30 days..."
                  find Tools/Automation -name "*ai_review*.md" -mtime +30 -delete || true
                  find Tools/Automation -name "*ai_review*.json" -mtime +30 -delete || true

            - name: Clean old MCP artifacts
              run: |
                  echo "Cleaning MCP artifacts older than 30 days..."
                  find Tools/Automation -name "*mcp_*.json" -mtime +30 -delete || true

            - name: Commit cleanup
              continue-on-error: true
              run: |
                  git config --local user.email "github-actions[bot]@users.noreply.github.com"
                  git config --local user.name "github-actions[bot]"

                  # Check if any files were deleted
                  if [[ -n $(git status --porcelain) ]]; then
                    git add -A
                    git commit -m "chore: automated artifact cleanup [skip ci]"
                    git push origin HEAD || echo "Push failed (may not have changes)"
                  else
                    echo "No artifacts to clean up"
                  fi

    daily-report:
        name: Generate Daily Report
        runs-on: ubuntu-latest
        needs: [health-check, log-rotation, branch-cleanup, artifact-cleanup]
        if: always()

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Download metrics snapshot
              uses: actions/download-artifact@v4
              with:
                  name: metrics-snapshot-${{ github.run_id }}
                  path: ./metrics

            - name: Set DATE environment variable
              run: echo "DATE=$(date +%Y-%m-%d)" >> $GITHUB_ENV

            - name: Generate report
              run: |
                  echo "# Daily System Report - $(date +%Y-%m-%d)" > daily_report.md
                  echo "" >> daily_report.md
                  echo "## Job Status" >> daily_report.md
                  echo "- Health Check: ${{ needs.health-check.result }}" >> daily_report.md
                  echo "- Log Rotation: ${{ needs.log-rotation.result }}" >> daily_report.md
                  echo "- Branch Cleanup: ${{ needs.branch-cleanup.result }}" >> daily_report.md
                  echo "- Artifact Cleanup: ${{ needs.artifact-cleanup.result }}" >> daily_report.md
                  echo "" >> daily_report.md
                  echo "## Metrics Snapshot" >> daily_report.md
                  echo '```json' >> daily_report.md
                  cat metrics/*.json | jq . >> daily_report.md || echo "{}" >> daily_report.md
                  echo '```' >> daily_report.md
                  echo "" >> daily_report.md
                  echo "## Details" >> daily_report.md
                  echo "- Workflow Run: [${{ github.run_id }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> daily_report.md
                  echo "- Triggered: $(date -u +%Y-%m-%dT%H:%M:%SZ)" >> daily_report.md

                  cat daily_report.md

            - name: Upload daily report
              uses: actions/upload-artifact@v4
              with:
                  name: daily-report-${{ env.DATE }}
                  path: daily_report.md
                  retention-days: 30

            - name: Post summary
              run: |
                  echo "## ðŸ“Š Daily Hygiene Summary" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  cat daily_report.md >> $GITHUB_STEP_SUMMARY
