import Foundation
import os
import OSLog
import SwiftData

@preconcurrency import UserNotifications

//
//  NotificationManager.swift
//  MomentumFinance
//
//  Created by Daniel Stevens on 6/2/25.
//  Copyright Â© 2025 Daniel Stevens. All rights reserved.
//

/// Manages smart notifications for budget limits and subscription due dates
///
/// This main coordinator delegates to focused component implementations:
/// - NotificationPermissionManager: Permission handling and authorization
/// - BudgetNotificationScheduler: Budget warning and alert scheduling
/// - SubscriptionNotificationScheduler: Payment reminder scheduling
/// - GoalNotificationScheduler: Milestone and achievement notifications
/// - NotificationTypes: Supporting enums and data models
@MainActor
public class NotificationManager: ObservableObject {
    static let shared = NotificationManager()

    @Published var isNotificationPermissionGranted = false
    @Published var pendingNotifications: [ScheduledNotification] = []

    private let center = UNUserNotificationCenter.current()
    private let logger = OSLog(
        subsystem: Bundle.main.bundleIdentifier ?? "MomentumFinance", category: "Notifications"
    )

    // Component delegates
    private let permissionManager: NotificationPermissionManager
    private let budgetScheduler: BudgetNotificationScheduler
    private let subscriptionScheduler: SubscriptionNotificationScheduler
    private let goalScheduler: GoalNotificationScheduler

    private init() {
        // Initialize component delegates
        self.permissionManager = NotificationPermissionManager(logger: self.logger)
        self.budgetScheduler = BudgetNotificationScheduler(logger: self.logger)
        self.subscriptionScheduler = SubscriptionNotificationScheduler(logger: self.logger)
        self.goalScheduler = GoalNotificationScheduler(logger: self.logger)

        self.checkNotificationPermission()
        self.setupNotificationCategories()
    }

    // MARK: - Permission Management (Delegate to PermissionManager)

    func requestNotificationPermission() async {
        let granted = await permissionManager.requestNotificationPermission()
        self.isNotificationPermissionGranted = granted
    }

    func checkNotificationPermission() {
        Task { @MainActor in
            let granted = await permissionManager.checkNotificationPermissionAsync()
            self.isNotificationPermissionGranted = granted
        }
    }

    // MARK: - Smart Budget Notifications (Delegate to BudgetScheduler)

    func schedulebudgetWarningNotifications(for budgets: [Budget]) {
        guard self.isNotificationPermissionGranted else { return }
        self.budgetScheduler.scheduleWarningNotifications(for: budgets)
    }

    func scheduleRolloverNotifications(for budgets: [Budget]) {
        guard self.isNotificationPermissionGranted else { return }
        self.budgetScheduler.scheduleRolloverNotifications(for: budgets)
    }

    func scheduleSpendingPredictionNotifications(for budgets: [Budget]) {
        guard self.isNotificationPermissionGranted else { return }
        self.budgetScheduler.scheduleSpendingPredictionNotifications(for: budgets)
    }

    // MARK: - Subscription Due Date Notifications (Delegate to SubscriptionScheduler)

    func scheduleSubscriptionNotifications(for subscriptions: [Subscription]) {
        guard self.isNotificationPermissionGranted else { return }
        self.subscriptionScheduler.scheduleNotifications(for: subscriptions)
    }

    // MARK: - Goal Milestone Notifications (Delegate to GoalScheduler)

    func checkGoalMilestones(for goals: [SavingsGoal]) {
        guard self.isNotificationPermissionGranted else { return }
        self.goalScheduler.checkMilestones(for: goals)
    }

    // MARK: - Notification Management

    func clearAllNotifications() {
        self.center.removeAllPendingNotificationRequests()
        self.center.removeAllDeliveredNotifications()
        self.pendingNotifications.removeAll()
    }

    func clearNotifications(ofType type: String) {
        Task { @MainActor in
            let requests = await center.pendingNotificationRequests()
            let identifiersToRemove =
                requests
                    .filter { request in
                        (request.content.userInfo["type"] as? String) == type
                    }
                    .map(\.identifier)

            self.center.removePendingNotificationRequests(withIdentifiers: identifiersToRemove)
        }
    }

    nonisolated func getPendingNotifications() async -> [ScheduledNotification] {
        let requests = await center.pendingNotificationRequests()

        return requests.compactMap { request in
            ScheduledNotification(
                id: request.identifier,
                title: request.content.title,
                body: request.content.body,
                type: request.content.userInfo["type"] as? String ?? "unknown",
                scheduledDate: (request.trigger as? UNCalendarNotificationTrigger)?
                    .nextTriggerDate()
            )
        }
    }

    // MARK: - Notification Categories Setup (Delegate to PermissionManager)

    func setupNotificationCategories() {
        // Set up notification categories
        let budgetCategory = UNNotificationCategory(
            identifier: "BUDGET_WARNING",
            actions: [],
            intentIdentifiers: [],
            options: .customDismissAction
        )

        let subscriptionCategory = UNNotificationCategory(
            identifier: "SUBSCRIPTION_REMINDER",
            actions: [],
            intentIdentifiers: [],
            options: .customDismissAction
        )

        UNUserNotificationCenter.current().setNotificationCategories([
            budgetCategory,
            subscriptionCategory
        ])
    }
}
