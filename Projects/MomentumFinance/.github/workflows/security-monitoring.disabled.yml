name: Security Monitoring

on:
  schedule:
    - cron: '0 2 * * *' # Daily at 2 AM
  workflow_dispatch:
  push:
    branches: [main]

jobs:
  security-audit:
    name: 'Security Audit'
    runs-on: macos-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Run Security Scanner
        run: |
          echo "ðŸ” Running advanced security scanner..."
          if [ -f "advanced_security_scanner.sh" ]; then
            chmod +x advanced_security_scanner.sh
            ./advanced_security_scanner.sh
          else
            echo "Security scanner script not found, performing basic checks..."
          fi

      - name: Check for Secrets
        run: |
          echo "ðŸ” Scanning for potential secrets..."
          # Simple secret detection patterns
          secret_patterns=(
            "api[_-]?key"
            "password"
            "secret"
            "token"
            "private[_-]?key"
          )
          for pattern in "${secret_patterns[@]}"; do
            if grep -ri "$pattern" MomentumFinance/ --include="*.swift" --exclude-dir=".git" > /dev/null 2>&1; then
              echo "âš ï¸ Potential secret pattern found: $pattern"
              echo "$pattern: FOUND" >> secret_findings.txt
            else
              echo "âœ… No instances of $pattern found"
            fi
          done

      - name: Generate Security Report
        run: |
          mkdir -p security_reports
          echo "# Security Audit Report - $(date)" > security_reports/daily_audit.md
          echo "" >> security_reports/daily_audit.md
          echo "## Summary" >> security_reports/daily_audit.md
          echo "- Scan completed at: $(date)" >> security_reports/daily_audit.md
          echo "- Repository: ${{ github.repository }}" >> security_reports/daily_audit.md
          echo "- Branch: ${{ github.ref_name }}" >> security_reports/daily_audit.md
          echo "" >> security_reports/daily_audit.md

          # Add findings summary
          if [ -f secret_findings.txt ]; then
            echo "## Secret Detection Results" >> security_reports/daily_audit.md
            echo "" >> security_reports/daily_audit.md
            cat secret_findings.txt >> security_reports/daily_audit.md
            echo "" >> security_reports/daily_audit.md
          else
            echo "## Secret Detection Results" >> security_reports/daily_audit.md
            echo "âœ… No potential secrets detected" >> security_reports/daily_audit.md
            echo "" >> security_reports/daily_audit.md
          fi

          # Add scan results if available
          if compgen -G "security_reports/security_scan_*.md" > /dev/null; then
            echo "## Detailed Findings" >> security_reports/daily_audit.md
            echo "See attached security scan reports for detailed findings." >> security_reports/daily_audit.md
          fi

      - name: Upload Security Audit Reports
        uses: actions/upload-artifact@v4
        with:
          name: security-audit-reports
          path: |
            security_reports/
            secret_findings.txt

      - name: Create Security Issue
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const runId = '${{ github.run_id }}';
            const runNumber = '${{ github.run_number }}';

            // Create issue for security concerns
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ðŸš¨ Security Audit Failed - Run #${runNumber}`,
              body: `## Security Audit Failure Report

              **Workflow Run**: #${runNumber}
              **Run ID**: ${runId}
              **Timestamp**: ${new Date().toISOString()}

              ### Security Concerns Detected
              The automated security audit has detected potential security issues that require immediate attention.

              ### Required Actions
              1. Review the security audit reports artifact
              2. Address any detected security vulnerabilities
              3. Review secret detection findings
              4. Update security policies if necessary

              ### Next Steps
              - Download the security audit reports from the workflow artifacts
              - Review each finding and determine appropriate remediation
              - Consider implementing additional security measures

              ---
              *Generated by Security Monitoring System*`,
              labels: ['security', 'audit-failure', 'urgent']
            });

            console.log(`Created security issue #${issue.data.number}`);
