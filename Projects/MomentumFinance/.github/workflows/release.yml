name: Release Automation

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v1.0.0)'
        required: true
        type: string

jobs:
  build-and-release:
    name: 'Build and Release'
    runs-on: macos-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Select Xcode Version
        run: sudo xcode-select -s /Applications/Xcode_15.0.app/Contents/Developer

      - name: Build Release Version
        run: |
          echo "ðŸ—ï¸ Building release version..."
          xcodebuild -scheme MomentumFinance \
            clean build \
            CODE_SIGNING_ALLOWED=NO

      - name: Run Full Test Suite
        run: |
          echo "ðŸ§ª Running full test suite..."
          xcodebuild test \
            CODE_SIGNING_ALLOWED=NO

      - name: Generate Release Notes
        run: |
          echo "ðŸ“ Generating release notes..."
          # Get version from tag or input
          VERSION="${{ github.ref_name }}"
          if [[ -z "$VERSION" ]]; then
            VERSION="${{ github.event.inputs.version }}"
          fi
          mkdir -p release_artifacts
          cat > release_artifacts/RELEASE_NOTES.md << EOF
          # MomentumFinance ${VERSION}

          Released on $(date -u +%Y-%m-%d)

          ## What's New

          ## Technical Improvements

          ## Security Updates

          **Full Changelog**: https://github.com/${{ github.repository }}/compare/previous...${VERSION}
          EOF

      - name: Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const version = '${{ github.ref_name }}' || '${{ github.event.inputs.version }}';

            try {
              const releaseNotes = fs.readFileSync('release_artifacts/RELEASE_NOTES.md', 'utf8');

              const release = await github.rest.repos.createRelease({
                owner: context.repo.owner,
                repo: context.repo.repo,
                tag_name: version,
                name: `MomentumFinance ${version}`,
                body: releaseNotes,
                draft: false,
                prerelease: version.includes('beta') || version.includes('alpha')
              });

              console.log(`Created release: ${release.data.html_url}`);
            } catch (error) {
              console.error('Failed to create release:', error);
              process.exit(1);
            }

      - name: Upload Release Artifacts
        if: startsWith(github.ref, 'refs/tags/')
        uses: actions/upload-artifact@v4
        with:
          name: release-artifacts-${{ github.ref_name }}
          path: release_artifacts/

      - name: Notify Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: actions/github-script@v7
        with:
          script: |
            const version = '${{ github.ref_name }}';

            // Create release announcement issue
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ðŸŽ‰ MomentumFinance ${version} Released!`,
              body: `## ðŸš€ New Release Available

              **Version**: ${version}
              **Release Date**: ${new Date().toISOString().split('T')[0]}

              ### What's New
              - Check the release notes for full details

              ### Download
              ðŸ“¦ [View Release](https://github.com/${context.repo.owner}/${context.repo.repo}/releases/tag/${version})

              ### Installation
              \`\`\`bash
              # Installation instructions here
              \`\`\`

              ---
              *This release was automatically created by the CI/CD pipeline*`,
              labels: ['release', 'announcement']
            });

            console.log(`Created release announcement: #${issue.data.number}`);
