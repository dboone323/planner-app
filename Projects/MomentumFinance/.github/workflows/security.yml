name: Security Scan

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  schedule:
    - cron: '0 0 * * 0' # Weekly on Sunday

jobs:
  security-scan:
    name: 'Security Vulnerability Scan'
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Run Bandit Security Scan
        run: |
          # Install security scanning tools
          echo "ðŸ” Installing security scanning tools..."
          brew install bandit || echo "Bandit not available, continuing with basic scans..."

          # Scan for common security issues
          echo "Scanning for hardcoded credentials..."
          grep -rn "password\|api_key\|secret\|token" . --include="*.swift" --exclude-dir=".git" > security-report.txt || echo "No hardcoded credentials found"

          echo "Scanning for HTTP URLs (should use HTTPS)..."
          grep -rn "http://" . --include="*.swift" --exclude-dir=".git" >> security-report.txt || echo "No HTTP URLs found"

          echo "Scanning for potential SQL injection points..."
          grep -rn "sqlite3_exec\|sqlite3_prepare" . --include="*.swift" --exclude-dir=".git" >> security-report.txt || echo "No SQL injection patterns found"

          echo "Security scan completed"

      - name: Upload Security Report
        uses: actions/upload-artifact@v4
        with:
          name: security-report
          path: security-report.txt
          retention-days: 30

  dependency-check:
    name: 'Dependency Vulnerability Check'
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check for Vulnerabilities in Dependencies
        run: |
          # Check for known vulnerabilities in Swift packages
          echo "ðŸ” Checking Swift Package dependencies..."
          if [ -f "Package.resolved" ]; then
            echo "Found Package.resolved, checking for known vulnerabilities..."
            # This would integrate with a vulnerability database
            echo "### Package.resolved Contents ###" > dependency-report.txt
            cat Package.resolved >> dependency-report.txt
          else
            echo "No Package.resolved found" > dependency-report.txt
          fi

          # Check for outdated dependencies
          echo "" >> dependency-report.txt
          echo "### Dependency Analysis ###" >> dependency-report.txt
          if command -v swift &> /dev/null; then
            echo "Checking for outdated dependencies..." >> dependency-report.txt
            swift package show-dependencies >> dependency-report.txt 2>&1 || echo "Swift package analysis failed" >> dependency-report.txt
          else
            echo "Swift not available for dependency analysis" >> dependency-report.txt
          fi

      - name: Upload Dependency Report
        uses: actions/upload-artifact@v4
        with:
          name: dependency-report
          path: dependency-report.txt
          retention-days: 30

  codeql-analysis:
    name: 'CodeQL Security Analysis'
    runs-on: macos-latest
    permissions:
      actions: read
      contents: read
      security-events: write
    steps:
      - uses: actions/checkout@v4

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: swift

      - name: Autobuild
        uses: github/codeql-action/autobuild@v3

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        with:
          category: '/language:swift'

  summary:
    name: 'Security Scan Summary'
    runs-on: ubuntu-latest
    needs: [security-scan, dependency-check, codeql-analysis]
    if: always()
    steps:
      - name: Generate Security Summary
        run: |
          echo "# ðŸ”’ Security Scan Summary" > security-summary.md
          echo "" >> security-summary.md
          echo "**Date**: $(date)" >> security-summary.md
          echo "**Repository**: ${{ github.repository }}" >> security-summary.md
          echo "**Branch**: ${{ github.ref_name }}" >> security-summary.md
          echo "" >> security-summary.md
          echo "## Scan Results" >> security-summary.md
          echo "- Security Scan: ${{ needs.security-scan.result }}" >> security-summary.md
          echo "- Dependency Check: ${{ needs.dependency-check.result }}" >> security-summary.md
          echo "- CodeQL Analysis: ${{ needs.codeql-analysis.result }}" >> security-summary.md
          echo "" >> security-summary.md

          if [[ "${{ needs.security-scan.result }}" == "failure" || "${{ needs.dependency-check.result }}" == "failure" || "${{ needs.codeql-analysis.result }}" == "failure" ]]; then
            echo "âš ï¸ **Security issues detected!** Review the individual scan reports for details." >> security-summary.md
          else
            echo "âœ… **All security scans passed successfully.**" >> security-summary.md
          fi

      - name: Upload Security Summary
        uses: actions/upload-artifact@v4
        with:
          name: security-summary
          path: security-summary.md
          retention-days: 30

      - name: Create Security Alert
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const runId = '${{ github.run_id }}';
            const runNumber = '${{ github.run_number }}';

            // Create security alert issue
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ðŸš¨ Security Vulnerabilities Detected - Run #${runNumber}`,
              body: `## Security Alert

              **Workflow Run**: #${runNumber}
              **Run ID**: ${runId}
              **Timestamp**: ${new Date().toISOString()}

              ### Security Scan Results
              The automated security scanning has detected potential vulnerabilities or security issues.

              ### Failed Checks
              - Security Scan: ${{ needs.security-scan.result }}
              - Dependency Check: ${{ needs.dependency-check.result }}
              - CodeQL Analysis: ${{ needs.codeql-analysis.result }}

              ### Required Actions
              1. Download the security scan artifacts from this workflow run
              2. Review each failed check's detailed report
              3. Address identified security vulnerabilities
              4. Update dependencies if vulnerable packages are found
              5. Fix any code quality issues identified by CodeQL

              ### Priority
              This issue should be addressed immediately to maintain security posture.

              ---
              *Generated by Automated Security Scanning*`,
              labels: ['security', 'vulnerability', 'urgent', 'needs-attention']
            });

            console.log(`Created security alert issue #${issue.data.number}`);
