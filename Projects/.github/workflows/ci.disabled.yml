name: CI Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  lint:
    name: Lint All Projects
    runs-on: macos-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install pre-commit
        run: |
          python -m pip install --upgrade pip
          pip install pre-commit

      - name: Install SwiftFormat and SwiftLint
        run: |
          brew install swiftformat swiftlint

      - name: Cache pre-commit
        uses: actions/cache@v3
        with:
          path: ~/.cache/pre-commit
          key: pre-commit-${{ runner.os }}-${{ hashFiles('.pre-commit-config.yaml') }}
          restore-keys: |
            pre-commit-${{ runner.os }}-

      - name: Run pre-commit hooks for AvoidObstaclesGame
        run: |
          cd AvoidObstaclesGame
          pre-commit run --all-files --hook-stage=pre-commit

      - name: Run pre-commit hooks for HabitQuest
        run: |
          cd HabitQuest
          pre-commit run --all-files --hook-stage=pre-commit

      - name: Run pre-commit hooks for MomentumFinance
        run: |
          cd MomentumFinance
          pre-commit run --all-files --hook-stage=pre-commit

      - name: Run pre-commit hooks for PlannerApp
        run: |
          cd PlannerApp
          pre-commit run --all-files --hook-stage=pre-commit

      - name: Run pre-commit hooks for CodingReviewer
        run: |
          cd CodingReviewer
          pre-commit run --all-files --hook-stage=pre-commit

  build-and-test:
    name: Build and Test All Projects
    runs-on: macos-latest
    needs: lint
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Xcode
        run: |
          sudo xcode-select -s /Applications/Xcode_15.4.app/Contents/Developer
          xcodebuild -version

      - name: Build and Test AvoidObstaclesGame
        run: |
          cd AvoidObstaclesGame
          xcodebuild -project AvoidObstaclesGame.xcodeproj -scheme AvoidObstaclesGame -configuration Debug -allowProvisioningUpdates build
          xcodebuild -project AvoidObstaclesGame.xcodeproj -scheme AvoidObstaclesGame -configuration Debug -allowProvisioningUpdates test

      - name: Build and Test HabitQuest
        run: |
          cd HabitQuest
          xcodebuild -project HabitQuest.xcodeproj -scheme HabitQuest -configuration Debug -allowProvisioningUpdates build
          xcodebuild -project HabitQuest.xcodeproj -scheme HabitQuest -configuration Debug -allowProvisioningUpdates test

      - name: Build and Test MomentumFinance
        run: |
          cd MomentumFinance
          xcodebuild -project MomentumFinance.xcodeproj -scheme MomentumFinance -configuration Debug -destination "platform=macOS" -allowProvisioningUpdates build
          xcodebuild -project MomentumFinance.xcodeproj -scheme MomentumFinance -configuration Debug -destination "platform=macOS" -allowProvisioningUpdates test

      - name: Build and Test PlannerApp
        run: |
          cd PlannerApp
          xcodebuild -project PlannerApp.xcodeproj -scheme PlannerApp -configuration Debug -destination "platform=macOS" -allowProvisioningUpdates build
          xcodebuild -project PlannerApp.xcodeproj -scheme PlannerApp -configuration Debug -destination "platform=macOS" -allowProvisioningUpdates test

      - name: Build and Test CodingReviewer
        run: |
          cd CodingReviewer
          xcodebuild -project CodingReviewer.xcodeproj -scheme CodingReviewer -configuration Debug -destination "platform=macOS" -allowProvisioningUpdates build
          xcodebuild -project CodingReviewer.xcodeproj -scheme CodingReviewer -configuration Debug -destination "platform=macOS" -allowProvisioningUpdates test

  shared-testing:
    name: Run Shared Component Tests
    runs-on: macos-latest
    needs: lint
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Swift
        run: |
          swift --version

      - name: Run Shared Testing Suite
        run: |
          cd ../Shared
          swift test

  documentation:
    name: Generate Documentation
    runs-on: macos-latest
    needs: [lint, build-and-test]
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Generate Documentation
        run: |
          bash scripts/gen_docs.sh
